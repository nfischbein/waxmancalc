<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Training Calculator</title>

        <!-- Bootstrap -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css">

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <script src="http://underscorejs.org/underscore-min.js"></script>

        <script type="text/javascript">

function nameToId(name) { return name.split(' ').join('_').toLowerCase(); }

function add(a, b) { return a + b; }

window.onload = function() {

    var exercises = [
    { name: 'Clean And Jerk', based_on: null, ratio: null },
    { name: 'Snatch',         based_on: null, ratio: null },
    { name: 'Clean',          based_on: 'Clean And Jerk', ratio: 1.02 },
    { name: 'Overhead Squat', based_on: 'Snatch',         ratio: 1.05 },
    { name: 'Back Squat',     based_on: 'Clean And Jerk', ratio: 1.34 },
    { name: 'Front Squat',    based_on: 'Clean And Jerk', ratio: 1.15 },
    { name: 'Jerk',           based_on: 'Clean And Jerk', ratio: 1.05 },
    { name: 'Seated Press',   based_on: 'Clean And Jerk', ratio: 0.55 },
    { name: 'Power Clean',    based_on: 'Clean And Jerk', ratio: 0.80 },
    { name: 'Power Snatch',   based_on: 'Snatch',         ratio: 0.80 },
    { name: 'Clean Blocks Abv Knee',  based_on: 'Clean',  ratio: 0.95 },
    { name: 'Snatch Blocks Abv Knee', based_on: 'Snatch', ratio: 0.95 },
    { name: 'Hang Clean Below Knee',  based_on: 'Clean',  ratio: 0.95 },
    { name: 'Hang Snatch Below Knee', based_on: 'Snatch', ratio: 0.95 }
    ];

    // Create a form field for each exercise
    for(i = 0; i < exercises.length; ++i) {
        var e = exercises[i];
        var id = nameToId(e.name);
        $('#form').append(`
                <div class="form-group">
                <label for="${id}" class="col-sm-2 control-label">${e.name}</label>
                <div class="col-sm-10" class="form-control">
                <input type="number" id="${id}">
                <span id="ideal_${id}"></span>
                </div>
                </div>
                `)
    }

    $(':input').change(function() {
            // Calculate the predicted accessories from the base lifts
            _.each(exercises, function(e) {
                var id = nameToId(e.name);
                var value = $('#' + id).val();

                // Find all lifts which are predicted by this lift and calculate the reverse prediction
                var predictors = _.chain(exercises)
                    .filter(function(p) {
                        return p.based_on == e.name && $('#' + nameToId(p.name)).val() != '';
                    })
                    .map(function(p) {
                            return {
                                    predictor: p.name,
                                    prediction: $('#' + nameToId(p.name)).val() / p.ratio
                                }; 
                        })
                    .value();

                // If this lift is predicted by a lift, add it to the predictions
                if(e.based_on !== null && $('#' + nameToId(e.based_on)).val() != '') {
                    predictors.push({
                        predictor: e.based_on,
                        prediction: $('#' + nameToId(e.based_on)).val() * e.ratio
                    });
                }

                $('#ideal_' + id).html('');
                if(predictors.length > 0) {

                    // Calculate the mean predicted value for this lift
                    var mean_prediction = _.chain(predictors).pluck('prediction').reduce(add, 0).value() / predictors.length;

                    $('#ideal_' + id).html('Ideal: ' + mean_prediction.toFixed(2));

                    // Show the standard deviation if this is predicted from > 1 value
                    if(predictors.length > 1) {
                        var stddev = Math.sqrt(
                                _.chain(predictors)
                                .pluck('prediction')
                                .map(function(v) { return (v - mean_prediction) * (v - mean_prediction); })
                                .reduce(add, 0)
                                .value() / (predictors.length - 1)
                                );
                        $('#ideal_' + id).append(' <i>&#177; ' + stddev.toFixed(2) + ' <small>stddev</small></i>');
                    }

                    // Show the percent off the predicted
                    if(value != '') {

                        var ideal_diff = (value / mean_prediction - 1.0) * 100;
                        var color = ideal_diff > 0 ? 'success' : 'danger';
                        $('#ideal_' + id).append(' <span class="label label-' + color + '"> ' +
                                (ideal_diff > 0 ? '+' : '') +
                                ideal_diff.toFixed(2) + '%</span>');

                    }

                    // Show which lifts predicted this one
                    $('#ideal_' + id).append(' <small>(Predicted by ' + _.pluck(predictors, 'predictor').join(', ') + ')</small>');

                }
            });

    });
};

        </script>

    </head>
    <body>

        <div class="container">
            <div class="panel panel-default">
                <div class="panel-body">
                    <form class="form-horizontal" id="form">
                    </form>
                </div>
            </div>
        </body>
    </html>
